<!DOCTYPE html>
<!--
    Type on Strap jekyll theme v2.2.4
    Copyright 2016-2019 Sylhare
    Theme free for personal and commercial use under the MIT license
    https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="/blog/assets/js/main.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="/blog/assets/css/main.css">

    <!--Favicon-->
    <link rel="shortcut icon" href="/blog/assets/img/favicon.png" type="image/x-icon">

    <!-- Canonical -->
    <link rel="canonical" href="https://naikoob.github.io/blog/2020/06/20/aws-cmdline.html">

    <!-- RSS -->
    <link rel="alternate" type="application/atom+xml" title="@naikoob" href="https://naikoob.github.io/blog/feed.xml"/>

    
    <!-- fontawesome -->
    <script defer src="https://use.fontawesome.com/releases/v5.13.1/js/all.js" integrity="sha384-heKROmDHlJdBb+n64p+i+wLplNYUZPaZmp2HZ4J6KCqzmd33FJ8QClrOV3IdHZm5" crossorigin="anonymous"></script>
  
    <!-- KaTeX 0.8.3 -->
    <!-- if you have any issue check https://github.com/KaTeX/KaTeX -->
    
    <script src="/blog/assets/js/vendor/katex.min.js"></script>
    

    <!-- Google Analytics -->
    

    <!-- seo tags -->
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Working with multiple AWS accounts on the command line | @naikoob</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Working with multiple AWS accounts on the command line" />
<meta name="author" content="naikoob" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="It is good practice to organise AWS workloads in multiple accounts, be it for security, accounting or just to maintain your sanity. Here is how I work with multiple accounts in my AWS Organization from the command line." />
<meta property="og:description" content="It is good practice to organise AWS workloads in multiple accounts, be it for security, accounting or just to maintain your sanity. Here is how I work with multiple accounts in my AWS Organization from the command line." />
<link rel="canonical" href="https://naikoob.github.io/blog/2020/06/20/aws-cmdline.html" />
<meta property="og:url" content="https://naikoob.github.io/blog/2020/06/20/aws-cmdline.html" />
<meta property="og:site_name" content="@naikoob" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-20T00:00:00+00:00" />
<script type="application/ld+json">
{"dateModified":"2020-06-20T00:00:00+00:00","datePublished":"2020-06-20T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://naikoob.github.io/blog/2020/06/20/aws-cmdline.html"},"@type":"BlogPosting","headline":"Working with multiple AWS accounts on the command line","url":"https://naikoob.github.io/blog/2020/06/20/aws-cmdline.html","author":{"@type":"Person","name":"naikoob"},"description":"It is good practice to organise AWS workloads in multiple accounts, be it for security, accounting or just to maintain your sanity. Here is how I work with multiple accounts in my AWS Organization from the command line.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta property="og:image" content="https://naikoob.github.io/blog/assets/img/pexels/keyboard.jpeg " />
</head>

  <body>
    <header class="site-header">

    <!-- Logo and title -->
	<div class="branding">
        

		<h1 class="site-title">
			<a aria-label="@naikoob" href="/blog/">
        @naikoob
      </a>
		</h1>
	</div>

    <!-- Toggle menu -->
    <nav class="clear">
    <a aria-label="pull" id="pull" class="toggle" href="#">
    <i class="fas fa-bars fa-lg"></i>
    </a>

    <!-- Menu -->
    <ul class="hide">
        

        
            
            
        
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Search" title="Search" href="/blog/search/">
                     <i class="fa fas fa-search" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Tags" title="Tags" href="/blog/tags/">
                     <i class="fa fas fa-tags" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            
        
    </ul>

	</nav>
</header>

    <div class="content">
      <article >
  <header id="main" style="">
    <div class="title-padder">
      
      <h1 id="Working+with+multiple+AWS+accounts+on+the+command+line" class="title">Working with multiple AWS accounts on the command line</h1>
      


<div class="post-info">
    <p class="meta">
      June 20, 2020
    </p></div>

      
    </div>
  </header>

  <section class="post-content">
  
      <div class="paragraph">
<p>It is good practice to organise AWS workloads in multiple accounts, be it for security, accounting or just to maintain your sanity. Here is how I work with multiple accounts in my AWS Organization from the command line.</p>
</div>
<div class="sect1">
<h2 id="accounts">account(s)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Why does AWS encourage multiple accounts setups (apart from getting customers further entrenched on the platform)? This <a href="https://www.youtube.com/watch?v=fxo67UeeN1A&amp;feature=youtu.be&amp;t=320" target="_blank" rel="noopener">video</a>(3:20-7:00) gives a good explanation.</p>
</div>
<div class="paragraph">
<p>As for me, I&#8217;m organising my demos and PoCs in a separate <code>Demo</code> account. This way, I can share admin access to my demos with my colleagues without exposing my main account. In addition, I&#8217;m also centralising my all IAM users in my main account, and access my <code>Demo</code> (and other accounts) by switching (assuming) roles. For readers new to this setup, I suggest this <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/tutorial_cross-account-with-roles.html">tutorial</a>.</p>
</div>
<div class="paragraph">
<p>In my <code>Demo</code> account, I create <code>DemoAdminRole</code> and <code>DemoPowerUserRole</code> roles, with the following trust policy to allow users from my main account to assume these roles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">Version</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2012-10-17</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">Statement</span><span class="delimiter">&quot;</span></span>: [
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">Effect</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Allow</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">Principal</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">AWS</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">arn:aws:iam::&lt;MAIN_ACCOUNT_NUM&gt;:root</span><span class="delimiter">&quot;</span></span>
      },
      <span class="key"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">sts:AssumeRole</span><span class="delimiter">&quot;</span></span>
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In my main account, I created proxy roles that do not have any other permission other then to assume roles in my <code>Demo</code> account with policy that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Version</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2012-10-17</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Statement</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">Effect</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Allow</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">sts:AssumeRole</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">Resource</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">arn:aws:iam::&lt;DEMO_ACCOUNT_NUM&gt;:role/&lt;DEMO_ROLE_NAME&gt;</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, to prevent creation of users and access keys in the <code>Demo</code> account, I attached a service control policy like so to my <code>Demo</code> account:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Version</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2012-10-17</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Statement</span><span class="delimiter">&quot;</span></span>: [
        {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">Sid</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Statement1</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">Effect</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Deny</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>: [
                <span class="string"><span class="delimiter">&quot;</span><span class="content">iam:CreateUser</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">iam:CreateAccessKey</span><span class="delimiter">&quot;</span></span>
            ],
            <span class="key"><span class="delimiter">&quot;</span><span class="content">Resource</span><span class="delimiter">&quot;</span></span>: [
                <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>
            ]
        }
    ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="profiles_profiles">profiles, profiles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>AWS CLI and SDKs make use of <code>~/.aws/config</code> and <code>~/.aws/credentials</code> to manage AWS profiles and credentials. My <code>~/.aws/config</code> file looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[profile demo]
region=ap-southeast-1
role_arn=arn:aws:iam::&lt;DEMO_ACCT_NUM&gt;:role/&lt;DEMO_ROLE_NAME&gt;
source_profile=demo

[profile main]
region=us-west-2
output=json</code></pre>
</div>
</div>
<div class="paragraph">
<p>and <code>~/.aws/credentials</code> looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[demo]
aws_access_key_id     = &lt;DEMO_PROXY_USER_ACCESS_KEY&gt;
aws_secret_access_key = &lt;DEMO_PROXY_USER_SECRET_KEY&gt;

[main]
aws_access_key_id     = &lt;MAIN_ACCESS_KEY&gt;
aws_secret_access_key = &lt;MAIN_SECRET_KEY&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="switching_between_profiles">switching between profiles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I deliberately not have a default profile to reduce the chance of targeting my scripts and ansible playbooks with the wrong profile. Instead, I added the following.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> to my <code>.zshrc</code> (and <code>.bashrc</code>) to allow me to quickly switch between profiles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># working with AWS profiles
function _aws_list_all {
    credentialFileLocation=${AWS_SHARED_CREDENTIALS_FILE};
    if [ -z $credentialFileLocation ]; then
        credentialFileLocation=~/.aws/credentials
    fi

    while read line; do
        if [[ $line == &quot;[&quot;* ]]; then echo &quot;$line&quot;; fi;
    done &lt; $credentialFileLocation;
};

function _aws_switch_profile() {
   if [ -z $1 ]; then  echo &quot;Usage: aws-profile profilename&quot;; return; fi

   exists=&quot;$(aws configure get aws_access_key_id --profile $1)&quot;
   if [[ -n $exists ]]; then
       export AWS_DEFAULT_PROFILE=$1;
       export AWS_PROFILE=$1;
       export AWS_REGION=$(aws configure get region --profile $1);
       echo &quot;Switched to AWS Profile: $1&quot;;
       aws configure list
   fi
};

alias aws-all=&quot;_aws_list_all&quot;
alias aws-profile=&quot;_aws_switch_profile&quot;
alias aws-whoami=&quot;aws configure list&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#160;<br>
I can then switch profiles using the 3 aliases like so:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/assets/img/aws-profiles.png" alt="switching profiles">
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. I got this off the Internet a while back, but can no longer find the source to give proper credit
</div>
</div>
    
  </section>

  <!-- Social media shares -->
  

<div class="share-buttons">
    <ul class="share-buttons">
        <div class="meta">Share</div>
         
        <li>
            <a href="https://twitter.com/intent/tweet?text=Working+with+multiple+AWS+accounts+on+the+command+line%20https%3A%2F%2Fnaikoob.github.io%2Fblog%2F2020%2F06%2F20%2Faws-cmdline.html" target="_blank" title="">
			<i class="fab fa-twitter-square fa-lg" aria-hidden="true"></i>
			<span class="sr-only">Tweet</span>
		</a>
        </li>
            
        <li>
            <a href="http://www.reddit.com/submit?url=https://naikoob.github.io/blog/2020/06/20/aws-cmdline.html&title=Working+with+multiple+AWS+accounts+on+the+command+line%20%7C%20%40naikoob" target="_blank" title=" Reddit">
			<i class="fab fa-reddit-square fa-lg" aria-hidden="true"></i>
			<span class="sr-only">Share on Reddit</span>
		</a>
        </li>
         
        <li>
            <a href="http://www.linkedin.com/shareArticle?mini=true&url=https://naikoob.github.io/blog/2020/06/20/aws-cmdline.html&title=Working+with+multiple+AWS+accounts+on+the+command+line%20%7C%20%40naikoob&summary=&source=https://naikoob.github.io/blog/2020/06/20/aws-cmdline.html" target="_blank" title=" LinkedIn">
			<i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
			<span class="sr-only">Share on LinkedIn</span>
		</a>
        </li>
          
        <li>
            <a href="mailto:?subject=Working+with+multiple+AWS+accounts+on+the+command+line%20%7C%20%40naikoob&body=:%20https://naikoob.github.io/blog/2020/06/20/aws-cmdline.html" target="_blank" title="">
			<i class="fas fa-envelope-square fa-lg" aria-hidden="true"></i>
			<span class="sr-only">Email</span>
		</a>
        </li>
        
    </ul>
</div>




   <!-- Tag list -->
  
  


<footer>
  <div class="tag-list">
    
      <div class="meta">Tags</div>
    

    
    <a class="button" href="/blog/tags#aws">
      <p><i class="fas fa-tag fa-fw"></i> aws</p>
    </a>
    
    <a class="button" href="/blog/tags#cloud">
      <p><i class="fas fa-tag fa-fw"></i> cloud</p>
    </a>
    
    <a class="button" href="/blog/tags#command+line">
      <p><i class="fas fa-tag fa-fw"></i> command line</p>
    </a>
    
    <a class="button" href="/blog/tags#security">
      <p><i class="fas fa-tag fa-fw"></i> security</p>
    </a>
    
  </div>
</footer>


</article>

<!-- Disqus -->


<!-- Post navigation -->

  <div id="post-nav">
    

    
    <div id="next-post">
        <a alt="On zsh, prezto and nerd fonts..." href="/blog/2020/06/10/my-terminal-setup.html">
            <p>Next post</p>
            On zsh, prezto and nerd fonts...
        </a>
    </div>
    
</div>



<!-- To change color of links in the page -->
<style>
  

  header#main {
    background-repeat:no-repeat;
  
  }
</style>

    </div>
    <footer class="site-footer">
    <p class="text">
        Powered by <a href="https://jekyllrb.com/">Jekyll</a> with <a href="https://github.com/sylhare/Type-on-Strap">Type on Strap</a>
</p>
            <div class="footer-icons">
                <ul>
                <!-- Social icons from Font Awesome, if enabled -->
                
<li>
    <a feed.xml href="feed.xml"
       title="Follow RSS feed">
        <span class="fa-stack fa-lg">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
        </span>
    </a>
</li>















<li>
    <a href="https://github.com/naikoob" title=" GitHub">
		<span class="fa-stack fa-lg">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-github fa-stack-1x fa-inverse"></i>
        </span>
    </a>
</li>







<li>
    <a href="https://www.linkedin.com/in/boo-kian-yeo-0663a410/" title=" LinkedIn">
		<span class="fa-stack fa-lg">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-linkedin-in fa-stack-1x fa-inverse"></i>
        </span>
    </a>
</li>



















<li>
    <a class="type" href="https://twitter.com/naikoob"
       title=" Twitter">
        <span class="fa-stack fa-lg">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
        </span>
    </a>
</li>








                </ul>
            </div>
</footer>

  </body>
</html>
